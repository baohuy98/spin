# Chat & Comments Feature Documentation

## T·ªïng quan

Chat & Comments feature cho ph√©p viewers v√† host giao ti·∫øp real-time trong room th√¥ng qua Socket.IO.

---

## üéØ Features

### ‚úÖ ƒê√£ ho√†n th√†nh

1. **Real-time Messaging**
   - G·ª≠i v√† nh·∫≠n messages t·ª©c th·ªùi
   - Auto-scroll ƒë·∫øn message m·ªõi nh·∫•t
   - Hi·ªÉn th·ªã timestamp cho m·ªói message

2. **UI/UX**
   - Modern chat interface v·ªõi shadcn components
   - Message bubbles v·ªõi m√†u kh√°c nhau cho own/other messages
   - Smooth animations khi message m·ªõi xu·∫•t hi·ªán (Framer Motion)
   - Character counter (500 characters max)
   - Empty state khi ch∆∞a c√≥ messages

3. **User Experience**
   - Disable input khi ch∆∞a connect ho·∫∑c ch∆∞a join room
   - Visual indicators cho connection status
   - Scroll area v·ªõi custom styling

---

## üìÅ File Structure

```
src/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ viewer/
‚îÇ       ‚îú‚îÄ‚îÄ ViewerPage.tsx          # Main viewer page v·ªõi chat integration
‚îÇ       ‚îî‚îÄ‚îÄ ChatComments.tsx        # Chat component (ISOLATED)
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useSocket.ts                # Socket.IO hook v·ªõi chat events
‚îî‚îÄ‚îÄ components/
    ‚îî‚îÄ‚îÄ ui/
        ‚îú‚îÄ‚îÄ input.tsx               # shadcn Input component
        ‚îú‚îÄ‚îÄ button.tsx              # shadcn Button component
        ‚îî‚îÄ‚îÄ scroll-area.tsx         # shadcn ScrollArea component
```

---

## üîß Technical Implementation

### 1. ChatComments Component

**Location**: [src/pages/viewer/ChatComments.tsx](src/pages/viewer/ChatComments.tsx)

**Props Interface**:
```typescript
interface ChatCommentsProps {
  roomId: string | null              // Room ID hi·ªán t·∫°i
  currentUserId: string              // ID c·ªßa user hi·ªán t·∫°i
  currentUserName: string            // T√™n hi·ªÉn th·ªã c·ªßa user
  messages: ChatMessage[]            // Danh s√°ch messages
  onSendMessage: (message: string) => void  // Callback khi g·ª≠i message
  isConnected: boolean               // Tr·∫°ng th√°i k·∫øt n·ªëi Socket.IO
}
```

**Message Interface**:
```typescript
export interface ChatMessage {
  id: string                // Unique message ID (generated by server)
  userId: string            // ID c·ªßa ng∆∞·ªùi g·ª≠i
  userName: string          // T√™n ng∆∞·ªùi g·ª≠i
  message: string           // N·ªôi dung message
  timestamp: number         // Unix timestamp
  roomId: string           // Room ID
}
```

**Key Features**:
- Auto-scroll ƒë·∫øn message m·ªõi nh·∫•t s·ª≠ d·ª•ng `useRef` v√† `scrollIntoView`
- Format timestamp th√†nh HH:MM format
- Distinguish own messages vs other messages
- Character limit: 500 characters
- Form validation: kh√¥ng g·ª≠i empty messages

**UI Components s·ª≠ d·ª•ng**:
- `ScrollArea` from shadcn - scrollable message list
- `Input` from shadcn - message input field
- `Button` from shadcn - send button
- `Send` icon from lucide-react
- `MessageCircle` icon from lucide-react

---

### 2. Socket.IO Events

**Location**: [src/hooks/useSocket.ts](src/hooks/useSocket.ts)

#### Client ‚Üí Server Events

**Event: `send-message`**
```typescript
// Payload
{
  roomId: string
  userId: string
  userName: string
  message: string
}

// Server s·∫Ω th√™m id v√† timestamp
```

#### Server ‚Üí Client Events

**Event: `chat-message`**
```typescript
// Payload - Real-time message broadcast
{
  id: string
  userId: string
  userName: string
  message: string
  timestamp: number
  roomId: string
}
```

**Event: `chat-history`** (Optional - khi join room)
```typescript
// Payload - Load previous messages
{
  messages: ChatMessage[]
}
```

---

### 3. useSocket Hook Updates

**New State**:
```typescript
const [messages, setMessages] = useState<ChatMessage[]>([])
```

**New Methods**:
```typescript
const sendChatMessage = (
  roomId: string,
  userId: string,
  userName: string,
  message: string
) => {
  if (socketRef.current) {
    const chatMessage: Omit<ChatMessage, 'id' | 'timestamp'> = {
      roomId,
      userId,
      userName,
      message
    }
    socketRef.current.emit('send-message', chatMessage)
  }
}
```

**Event Listeners**:
```typescript
// Listen for new messages
newSocket.on('chat-message', (data: ChatMessage) => {
  console.log('Received chat message:', data)
  setMessages(prev => [...prev, data])
})

// Listen for chat history (when joining room)
newSocket.on('chat-history', (data: { messages: ChatMessage[] }) => {
  console.log('Received chat history:', data)
  setMessages(data.messages)
})
```

**Return Values** (updated):
```typescript
return {
  // ... existing returns
  messages,           // Chat messages array
  sendChatMessage     // Function to send message
}
```

---

### 4. ViewerPage Integration

**Import**:
```typescript
import ChatComments from './ChatComments'
```

**S·ª≠ d·ª•ng**:
```tsx
<ChatComments
  roomId={roomId}
  currentUserId={genID}
  currentUserName={genID}  // TODO: Replace with actual user name
  messages={messages}
  onSendMessage={(message) => {
    if (roomId) {
      sendChatMessage(roomId, genID, genID, message)
    }
  }}
  isConnected={isConnected}
/>
```

---

## üöÄ Backend Requirements (C·∫ßn implement)

### Socket.IO Server Events

#### Event: `send-message`

**Handler**:
```javascript
socket.on('send-message', (data) => {
  const { roomId, userId, userName, message } = data

  // Validate
  if (!roomId || !userId || !message?.trim()) {
    socket.emit('error', { message: 'Invalid message data' })
    return
  }

  // Validate message length
  if (message.length > 500) {
    socket.emit('error', { message: 'Message too long' })
    return
  }

  // Create full message object
  const chatMessage = {
    id: generateUniqueId(),  // UUID or similar
    userId,
    userName,
    message: message.trim(),
    timestamp: Date.now(),
    roomId
  }

  // Save to database (optional - for chat history)
  // await saveMessage(chatMessage)

  // Broadcast to all members in room
  io.to(roomId).emit('chat-message', chatMessage)
})
```

#### Event: `chat-history` (Optional)

**When to emit**: Khi viewer joins room

```javascript
socket.on('join-room', async ({ roomId, memberId }) => {
  // ... existing join room logic

  // Load and send chat history
  const messages = await loadChatHistory(roomId, limit = 50)
  socket.emit('chat-history', { messages })

  // ... rest of join logic
})
```

---

## üíæ Database Schema (Optional - for persistence)

### Table: `chat_messages`

```sql
CREATE TABLE chat_messages (
  id VARCHAR(36) PRIMARY KEY,           -- UUID
  room_id VARCHAR(255) NOT NULL,        -- Room ID
  user_id VARCHAR(255) NOT NULL,        -- User ID
  user_name VARCHAR(255) NOT NULL,      -- User display name
  message TEXT NOT NULL,                -- Message content
  timestamp BIGINT NOT NULL,            -- Unix timestamp
  created_at TIMESTAMP DEFAULT NOW(),

  INDEX idx_room_timestamp (room_id, timestamp),
  INDEX idx_room_created (room_id, created_at)
);
```

**Queries**:

```sql
-- Insert message
INSERT INTO chat_messages (id, room_id, user_id, user_name, message, timestamp)
VALUES (?, ?, ?, ?, ?, ?);

-- Get recent messages for room
SELECT * FROM chat_messages
WHERE room_id = ?
ORDER BY timestamp DESC
LIMIT 50;

-- Delete old messages (cleanup job)
DELETE FROM chat_messages
WHERE created_at < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

---

## üé® UI/UX Details

### Message Bubble Styling

**Own Messages** (right-aligned):
- Background: `bg-primary` (purple)
- Text: `text-primary-foreground` (white)
- Alignment: `justify-end`

**Other Messages** (left-aligned):
- Background: `bg-accent` (gray)
- Text: default foreground color
- Alignment: `justify-start`
- Shows userName label

### Animations

```typescript
// Message enter animation (Framer Motion)
initial={{ opacity: 0, y: 10 }}
animate={{ opacity: 1, y: 0 }}
transition={{ duration: 0.2 }}
```

### Auto-scroll Logic

```typescript
// Scroll to bottom when new message arrives
useEffect(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
}, [messages])
```

---

## üîê Security Considerations

### Input Validation

‚úÖ **Frontend**:
- Max length: 500 characters
- Trim whitespace
- Disable send button khi empty

‚ö†Ô∏è **Backend** (c·∫ßn implement):
- Validate message length
- Sanitize HTML/XSS
- Rate limiting (max messages per minute)
- Profanity filter (optional)
- Spam detection

### Example Backend Validation:

```javascript
// Rate limiting - max 10 messages per minute per user
const rateLimiter = new Map()

socket.on('send-message', (data) => {
  const { userId } = data

  // Check rate limit
  const now = Date.now()
  const userLimit = rateLimiter.get(userId) || { count: 0, resetAt: now + 60000 }

  if (now > userLimit.resetAt) {
    userLimit.count = 0
    userLimit.resetAt = now + 60000
  }

  if (userLimit.count >= 10) {
    socket.emit('error', { message: 'Too many messages. Please slow down.' })
    return
  }

  userLimit.count++
  rateLimiter.set(userId, userLimit)

  // ... rest of message handling
})
```

---

## üìù TODO & Future Enhancements

### High Priority
- [ ] **Backend Implementation**
  - [ ] Socket.IO event handlers
  - [ ] Rate limiting
  - [ ] Message validation & sanitization

- [ ] **User Names**
  - [ ] Replace `genID` v·ªõi actual user names t·ª´ memberList
  - [ ] Display user avatars (optional)

### Medium Priority
- [ ] **Message Persistence**
  - [ ] Database setup cho chat history
  - [ ] Load previous messages khi join room
  - [ ] Pagination cho old messages

- [ ] **Typing Indicators**
  - [ ] Show "User is typing..." indicator
  - [ ] Socket event: `user-typing`

- [ ] **Read Receipts**
  - [ ] Mark messages as read
  - [ ] Show read status

### Low Priority
- [ ] **Rich Features**
  - [ ] Emoji picker
  - [ ] Link preview
  - [ ] Image/file upload
  - [ ] Reactions to messages

- [ ] **Moderation**
  - [ ] Message delete (host only)
  - [ ] Mute users
  - [ ] Profanity filter

- [ ] **Notifications**
  - [ ] Sound notification cho new messages
  - [ ] Desktop notifications (v·ªõi permission)
  - [ ] Unread message counter

---

## üß™ Testing Checklist

### Manual Testing

- [ ] G·ª≠i message th√†nh c√¥ng
- [ ] Nh·∫≠n message t·ª´ user kh√°c real-time
- [ ] Auto-scroll ho·∫°t ƒë·ªông khi c√≥ message m·ªõi
- [ ] Character counter hi·ªÉn th·ªã ƒë√∫ng
- [ ] Kh√¥ng g·ª≠i ƒë∆∞·ª£c empty messages
- [ ] Kh√¥ng g·ª≠i ƒë∆∞·ª£c khi ch∆∞a connect
- [ ] Messages c√≥ m√†u kh√°c nhau (own vs others)
- [ ] Timestamp format ƒë√∫ng
- [ ] Scroll area ho·∫°t ƒë·ªông v·ªõi nhi·ªÅu messages
- [ ] UI responsive tr√™n mobile

### Edge Cases

- [ ] G·ª≠i message c√≥ special characters
- [ ] G·ª≠i message 500 characters
- [ ] G·ª≠i message khi m·∫•t k·∫øt n·ªëi
- [ ] Reconnect v√† v·∫´n gi·ªØ messages
- [ ] Multiple users c√πng g·ª≠i message
- [ ] Leave room v√† rejoin - messages c√≥ load l·∫°i?

---

## üêõ Known Issues

### Issue 1: Messages kh√¥ng persist khi reload page
**Severity**: üü° MEDIUM
**Current Behavior**: Messages bi·∫øn m·∫•t khi refresh page
**Expected Behavior**: Load chat history t·ª´ server
**Solution**: Implement `chat-history` event v√† database storage

### Issue 2: userName hi·ªán genID thay v√¨ actual name
**Severity**: üü° MEDIUM
**Current Behavior**: Display user ID instead of friendly name
**Solution**: Map genID ‚Üí user name t·ª´ memberList
```typescript
// In ViewerPage.tsx
const userName = memberList.find(m => m.genID === genID)?.name || genID
```

### Issue 3: Kh√¥ng c√≥ typing indicators
**Severity**: üîµ LOW
**Status**: Feature request
**Solution**: Implement trong future enhancement

---

## üìä Performance Considerations

### Message Limit
- **Current**: Kh√¥ng c√≥ limit, t·∫•t c·∫£ messages ƒë∆∞·ª£c l∆∞u trong state
- **Recommendation**: Limit messages trong memory (e.g., 100 messages)
- **Implementation**:
```typescript
// In useSocket.ts
newSocket.on('chat-message', (data: ChatMessage) => {
  setMessages(prev => {
    const updated = [...prev, data]
    // Keep only last 100 messages
    return updated.slice(-100)
  })
})
```

### Scroll Performance
- **Current**: Re-render to√†n b·ªô message list khi c√≥ message m·ªõi
- **Optimization**: S·ª≠ d·ª•ng `React.memo` cho message items
- **Implementation**:
```typescript
const MessageItem = React.memo(({ message, isOwn }) => {
  // ... message rendering
})
```

---

## üîó Integration v·ªõi HostPage

**Status**: ‚ö†Ô∏è Ch∆∞a implement

**Plan**:
1. Add ChatComments component v√†o HostPage
2. Reuse c√πng m·ªôt component
3. Host c√≥ th·ªÉ chat v·ªõi viewers
4. Optional: Host c√≥ quy·ªÅn delete messages

**File to modify**: [src/pages/host/HostPage.tsx](src/pages/host/HostPage.tsx)

---

## üìû Support Resources

### Socket.IO Documentation
- [Emitting Events](https://socket.io/docs/v4/emitting-events/)
- [Listening to Events](https://socket.io/docs/v4/listening-to-events/)
- [Rooms](https://socket.io/docs/v4/rooms/)

### shadcn/ui Components
- [Input](https://ui.shadcn.com/docs/components/input)
- [Button](https://ui.shadcn.com/docs/components/button)
- [Scroll Area](https://ui.shadcn.com/docs/components/scroll-area)

### Framer Motion
- [Animation Variants](https://www.framer.com/motion/animation/)


